{% extends "base.html" %}

{% block title %}Open Case - Police Record System{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-bold text-cyan-400">Open New Case</h2>
            <p class="text-slate-400 text-sm">Capture core case metadata and assign a lead officer.</p>
        </div>
        <a href="{{ url_for('cases') }}" class="text-slate-400 hover:text-slate-200 text-sm">Back to cases</a>
    </div>

    <form method="POST" id="caseForm" class="bg-slate-900 border border-slate-700 rounded-lg p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Case Number is auto-generated -->
            <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Priority</label>
                <select name="priority"
                    class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Status</label>
                <select name="status" class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white">
                    <option value="open" selected>Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Lead Officer</label>
                <select name="lead_officer_id"
                    class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white">
                    <option value="">Unassigned</option>
                    {% for officer in officers %}
                    <option value="{{ officer.id }}">{{ officer.full_name }} ({{ officer.badge_number }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Case Type & Section -->
            <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Case Type</label>
                <select id="caseType" class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white"
                    onchange="updateSection()">
                    <option value="">Select Type</option>
                    {% for type, section in case_types.items() %}
                    <option value="{{ type }}" data-section="{{ section }}">{{ type }}</option>
                    {% endfor %}
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-sm font-semibold text-slate-300 mb-2">Applicable Section</label>
            <input type="text" id="sectionInput" placeholder="Auto-filled based on Case Type"
                class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-400">
            <p class="text-xs text-slate-500 mt-1">You can manually edit this if needed.</p>
        </div>

        <div>
            <label class="block text-sm font-semibold text-slate-300 mb-2">Case Title</label>
            <input type="text" name="title" required
                class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-400">
        </div>

        <div>
            <label class="block text-sm font-semibold text-slate-300 mb-2">Case Description</label>
            <textarea name="description" rows="5" required
                class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-400"></textarea>
        </div>

        <div class="flex justify-end gap-3">
            <a href="{{ url_for('cases') }}"
                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white">Cancel</a>
            <button type="submit" class="px-5 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white font-semibold">
                Create Case
            </button>
        </div>
    </form>
</div>

<script>
    function updateSection() {
        const select = document.getElementById('caseType');
        const sectionInput = document.getElementById('sectionInput');
        const titleInput = document.querySelector('input[name="title"]');
        const selectedOption = select.options[select.selectedIndex];
        const section = selectedOption.getAttribute('data-section');

        if (section) {
            sectionInput.value = section;

            // Auto-generate title: [Case Type] - [Date]
            const today = new Date().toISOString().split('T')[0];
            const newTitle = `${select.value} Case - ${today}`;

            // Check if current title is empty or was likely auto-generated
            const currentTitle = titleInput.value;
            const isAutoGenerated = currentTitle === "" || currentTitle.includes("Case - 20");

            if (isAutoGenerated) {
                titleInput.value = newTitle;
            }

        } else if (select.value === 'Other') {
            sectionInput.value = '';
            sectionInput.focus();
        }
    }
</script>
{% endblock %}