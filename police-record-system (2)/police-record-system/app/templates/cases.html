{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-cyan-400">Cases</h2>
        <a href="{{ url_for('cases.create_case') }}"
            class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">
            <i class="fas fa-plus mr-2"></i>New Case
        </a>
    </div>

    <!-- Search Bar -->
    <form method="GET" action="{{ url_for('cases.list_cases') }}" class="mb-8 relative">
        <div class="flex gap-4">
            <div class="relative flex-grow">
                <input type="text" name="search" id="caseSearchInput" value="{{ search_query }}"
                    placeholder="Search by Case #, Title, or Description (Eng/Hindi)..."
                    class="w-full px-4 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-400"
                    autocomplete="off">
                <div id="caseSearchResults"
                    class="absolute top-full left-0 w-full bg-slate-800 border border-slate-700 rounded shadow-lg mt-1 hidden z-50 max-h-64 overflow-y-auto">
                </div>
            </div>

            <button type="submit"
                class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded border border-slate-600">
                Search
            </button>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('caseSearchInput');
            const results = document.getElementById('caseSearchResults');

            if (input) {
                let timer;
                input.addEventListener('input', function () {
                    clearTimeout(timer);
                    const q = this.value.trim();
                    if (q.length < 2) {
                        results.classList.add('hidden');
                        return;
                    }
                    timer = setTimeout(async () => {
                        try {
                            const res = await fetch(`/search_name?q=${encodeURIComponent(q)}&threshold=60`);
                            const data = await res.json();
                            results.innerHTML = '';
                            if (data.results && data.results.length > 0) {
                                results.classList.remove('hidden');
                                data.results.forEach(item => {
                                    const div = document.createElement('div');
                                    div.className = 'px-4 py-2 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-0';
                                    div.innerHTML = `
                                        <div class="flex justify-between">
                                            <span class="font-bold text-white">${item.name}</span>
                                            <span class="text-xs text-yellow-500">${Math.round(item.score)}%</span>
                                        </div>
                                        <div class="text-xs text-gray-400">${item.source} | ${item.details}</div>
                                    `;
                                    div.addEventListener('click', () => {
                                        window.location.href = item.url;
                                    });
                                    results.appendChild(div);
                                });
                            } else {
                                results.classList.remove('hidden');
                                results.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No matches</div>';
                            }
                        } catch (e) { console.error(e); }
                    }, 300);
                });
                document.addEventListener('click', e => {
                    if (!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden');
                });
            }
        });
    </script>

    <!-- Cases List -->
    <div class="bg-slate-800 rounded-lg shadow overflow-hidden border border-slate-700">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th
                        class="px-5 py-3 border-b-2 border-slate-700 bg-slate-900 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Case #
                    </th>
                    <th
                        class="px-5 py-3 border-b-2 border-slate-700 bg-slate-900 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Title
                    </th>
                    <th
                        class="px-5 py-3 border-b-2 border-slate-700 bg-slate-900 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Status
                    </th>
                    <th
                        class="px-5 py-3 border-b-2 border-slate-700 bg-slate-900 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Priority
                    </th>
                    <th
                        class="px-5 py-3 border-b-2 border-slate-700 bg-slate-900 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Date
                    </th>
                    <th
                        class="px-5 py-3 border-b-2 border-slate-700 bg-slate-900 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for case in cases.items %}
                <tr>
                    <td class="px-5 py-5 border-b border-slate-700 bg-slate-800 text-sm">
                        <p class="text-gray-300 whitespace-no-wrap">{{ case.case_number }}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-slate-700 bg-slate-800 text-sm">
                        <p class="text-gray-300 whitespace-no-wrap">{{ case.title }}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-slate-700 bg-slate-800 text-sm">
                        <span class="relative inline-block px-3 py-1 font-semibold leading-tight">
                            <span aria-hidden
                                class="absolute inset-0 opacity-50 rounded-full
                                {% if case.status == 'Open' %}bg-green-200{% elif case.status == 'In Progress' %}bg-yellow-200{% else %}bg-red-200{% endif %}"></span>
                            <span
                                class="relative 
                                {% if case.status == 'Open' %}text-green-900{% elif case.status == 'In Progress' %}text-yellow-900{% else %}text-red-900{% endif %}">
                                {{ case.status }}
                            </span>
                        </span>
                    </td>
                    <td class="px-5 py-5 border-b border-slate-700 bg-slate-800 text-sm">
                        <span
                            class="text-{{ 'red-400' if case.priority == 'High' else 'yellow-400' if case.priority == 'Medium' else 'green-400' }}">
                            {{ case.priority }}
                        </span>
                    </td>
                    <td class="px-5 py-5 border-b border-slate-700 bg-slate-800 text-sm">
                        <p class="text-gray-300 whitespace-no-wrap">{{ case.created_at.strftime('%Y-%m-%d') }}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-slate-700 bg-slate-800 text-sm">
                        <a href="{{ url_for('cases.case_detail', case_id=case.id) }}"
                            class="text-cyan-400 hover:text-cyan-300 mr-3">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 flex justify-center">
        {% if cases.has_prev %}
        <a href="{{ url_for('cases.list_cases', page=cases.prev_num, search=search_query) }}"
            class="px-3 py-1 bg-slate-700 text-white rounded mr-2">Previous</a>
        {% endif %}
        {% if cases.has_next %}
        <a href="{{ url_for('cases.list_cases', page=cases.next_num, search=search_query) }}"
            class="px-3 py-1 bg-slate-700 text-white rounded">Next</a>
        {% endif %}
    </div>
</div>
{% endblock %}